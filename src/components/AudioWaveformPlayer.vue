<template>
  <div class="w-full h-full flex flex-col">
    <div class="mb-4 mt-8 text-center flex-shrink-0" v-show="showTitle">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">{{ title }}</h2>
      <p class="text-gray-600">{{ subtitle }}</p>
    </div>
    
    <div class="relative flex-1 overflow-y-auto">
      <div v-for="(buffer, name) in audioBuffers" :key="name" class="mb-1 bg-white rounded-lg shadow flex w-full relative">
        <div class="w-32 h-20 bg-slate-100 flex justify-center items-center flex-shrink-0">
          <!-- 鼓图标 -->
          <div v-if="name === 'drums'" class="flex flex-col items-center">
            <svg class="w-8 h-8" viewBox="0 0 1161 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1725" width="200" height="200"><path d="M162.842479 19.133293l-85.192035-9.014358c29.798168-13.369182 58.187048-10.37286 85.192035 9.014358z" fill="#F8DF9D" p-id="1726"></path><path d="M261.238644 47.699921l-29.07448-9.014358a70.36278 70.36278 0 0 1 10.283986-31.994624c2.158367-3.529566 5.713326-5.865681 9.649172-6.348139 34.53388-4.316735 11.426651 33.391215 9.141322 47.357121z" fill="#265360" p-id="1727"></path><path d="M77.650444 10.118935l85.192035 9.014358 69.321685 19.55227 29.07448 9.014358c18.536568 12.061465 113.250812 55.736666 122.392132 86.588626a6.030733 6.030733 0 0 1-0.685599 4.786497 6.284658 6.284658 0 0 1-4.012024 2.83127c-26.154335 5.586363-51.635768 3.808884-76.431602-5.332437a175.500669 175.500669 0 0 0-78.843894-18.536568l-10.030061-6.855991c-11.172726-4.697623-164.289855-72.368792-135.977152-101.062383z" fill="#FFC133" p-id="1728"></path><path d="M953.693718 83.122541l-25.392558 9.522209a60.789785 60.789785 0 0 1-6.982954-34.152991 8.252582 8.252582 0 0 1 6.982954-7.490805c18.625442-2.374204 27.081164 8.341456 25.392558 32.121587z" fill="#1D4D59" p-id="1729"></path><path d="M984.418714 146.603937c-11.007674-1.104576-20.529884 2.069494-28.566628 9.52221l-117.186658 23.107228a14.791165 14.791165 0 0 1-11.80754-2.793181c-25.773447-20.187084 87.604327-75.796788 101.443272-83.795444l25.392558-9.522209 126.835831-26.154336a8.379544 8.379544 0 0 1 9.395247 4.697624c13.585019 29.836256-83.922406 72.622718-105.506082 84.938108z" fill="#FFC133" p-id="1730"></path><path d="M213.627596 111.181318l10.030061 6.855991 2.666218 12.188428-31.613735 71.099164c-1.460072 3.326425-4.659535 6.157695-8.887396 7.871694l-34.533879 14.600721c-13.293004 5.586363-19.933159 15.781475-19.933159 30.598033l-0.126963 511.279169c0 10.71566 3.935847 21.063127 11.045763 29.074479 2.793181 3.047107 120.868579 116.678807 62.084806 108.299263a17.089192 17.089192 0 0 1-10.537912-5.967251l-52.054745-59.799476c-6.944865-7.871693-10.410949-6.640154-10.410949 3.681921l-0.253926 95.476021c0 4.316735-1.701301 8.125619-4.57066 10.283986-40.882019 30.344108-26.154335-93.698541-25.392559-104.236453 0.761777-9.306373-2.196456-10.537912-8.887395-3.681921l-61.576955 62.084806a10.410949 10.410949 0 0 1-10.9188 2.412293c-14.562632-5.421311-15.400587-15.235535-2.539256-29.455368 39.523518-43.586327 65.55089-72.914732 78.082118-87.985216a17.26694 17.26694 0 0 0 3.935846-11.299689l-0.761776-514.326276a6.602065 6.602065 0 0 0-6.34814-6.602065c-25.811536-0.3428-48.880675 5.624452-69.194723 17.901754-3.61844 2.221849-7.820908 2.551952-11.045763 0.88874-14.130959-7.021042-15.654512-17.393903-4.57066-31.105885 13.458056 1.523554 25.100544-2.374204 34.914768-11.680577l119.0911-44.817866c4.012024-1.548946 7.211487-4.215165 9.014359-7.490805 8.125619-14.98161 24.884707-68.813834 43.294312-66.147615z" fill="#265360" p-id="1731"></path><path d="M302.501551 136.573877c-29.328405 1.777479-52.562596-23.361154-76.177676-6.34814l-2.666218-12.188428c27.589015 0 53.870313 6.183088 78.843894 18.536568z" fill="#F8DF9D" p-id="1732"></path><path d="M984.418714 146.603937l20.948861 54.213113c1.548946 3.910454 4.431001 6.970257 7.998656 8.506507 41.643796 17.520865 83.70657 33.480089 126.201017 47.864973 15.362498 5.205475 32.502475 18.155679 12.696279 32.629438a12.340784 12.340784 0 0 1-11.553614 1.269628l-58.021997-21.583675c-4.113595-1.510857-8.354152-0.685599-10.410949 2.031405-2.958233 3.897758-3.212159 8.125619-0.761776 12.696279 2.28533 4.481787 3.427995 8.379544 3.427995 11.680577l-2.539256 447.67081c-0.088874 3.92315 1.409287 7.871693 4.189772 11.045763 2.793181 3.17407 118.202361 117.186658 57.641108 104.236453-3.61844-0.736384-7.236879-3.021714-10.283986-6.475102l-41.262908-45.960532c-6.944865-7.706642-10.537912-6.310051-10.791837 4.189773l-2.28533 82.906704c-0.152355 4.113595-2.793181 7.579679-6.475103 8.506507-4.227861 1.015702-8.163708 0.799866-11.80754-0.634814-3.427995-1.231539-5.967251-4.862675-6.602065-9.395247a282.669963 282.669963 0 0 1 0-85.318997c1.523554-9.484121-1.396591-10.410949-8.760433-2.793181l-50.02334 52.181708c-3.047107 3.123285-7.160702 4.71032-11.172726 4.316735-43.421275-4.189772 54.467038-94.841207 61.957843-102.7129 2.843967-3.009018 4.443698-6.868687 4.443698-10.791838l0.253926-483.855205c0-4.36752-2.107582-8.125619-5.332438-9.52221l-36.438321-15.362498c-4.723016-2.031405-8.252582-4.507179-9.776136-6.85599a255.119037 255.119037 0 0 1-34.026028-75.161974c8.036745-7.452716 17.558954-10.626786 28.566628-9.52221z" fill="#1D4D59" p-id="1733"></path><path d="M426.290275 226.463534l88.873955 37.073136a90.740308 90.740308 0 0 1 40.247206 17.774791c3.339121 2.615434 5.56097 6.335443 6.221177 10.410949 3.897758 24.795834-8.595381 37.796824-37.454024 38.977578-12.823242-6.855991-142.960105-78.589969-134.96145-38.342764-29.544242-56.282606-17.178066-78.24717 37.073136-65.89369zM771.756036 276.740801a385.103545 385.103545 0 0 0-132.676119 56.498443l-26.281299-9.776135c-4.545268-1.701301-7.947871-4.189772-9.395246-6.855991-13.458056-23.234191-1.777479-38.215801 20.94886-47.103197 38.596689-15.235535 81.345062-31.740698 128.232422-49.515489 17.431992-6.602065 28.52854-0.88874 33.264252 17.139977 3.973935 15.324409-0.723688 28.52854-14.09287 39.612392z" fill="#357DA2" p-id="1734"></path><path d="M426.290275 226.463534c32.591349 5.243563 62.211769 17.609739 88.873955 37.073136l-88.873955-37.073136z" fill="#CDDEDF" p-id="1735"></path><path d="M42.227825 229.637604c-9.814224 9.306373-21.456712 13.204131-34.914768 11.680577 8.887396-10.753749 20.529884-14.63881 34.914768-11.680577z" fill="#9DC2C4" p-id="1736"></path><path d="M524.178589 330.699988l-15.362498 43.040387a4.672231 4.672231 0 0 0 0.672902 4.392912 5.243563 5.243563 0 0 0 4.151684 2.08219l134.453598 0.761777c1.701301 0.025393 3.301033-0.761777 4.316735-2.069494a4.799194 4.799194 0 0 0 0.761777-4.532571l-14.09287-41.135945a385.103545 385.103545 0 0 1 132.676119-56.498443l29.074479 75.669824c-49.858289 25.049759-99.88163 45.325717-150.070022 60.815178l-41.262907 1.269628c-3.72001 0.139659-6.678243 3.427995-6.729028 7.490805l-1.904442 95.476021c-11.337777 4.91346-22.091526 4.024721-32.24855-2.666219l-0.253925-94.460318a6.602065 6.602065 0 0 0-6.34814-6.602065l-46.722308-1.142666c-52.816522-11.845629-104.274542-32.972237-154.386757-63.354433l28.312703-56.879332c-7.998656-40.247205 122.138207 31.486773 134.96145 38.342764z" fill="#1D4D59" p-id="1737"></path><path d="M360.904436 349.236556c50.112215 30.382196 101.570235 51.508805 154.386757 63.354433 2.031405 27.589015-6.817902 43.129261-26.535224 46.595346-28.312703 5.078512-110.203705-36.311359-140.547812-47.738011-23.107228-8.63347-33.772103-24.757745-20.821898-47.484084 1.447376-2.501167 4.951549-4.900764 9.649172-6.602066l23.869005-8.125618zM800.830515 352.410625c34.53388 2.882055 46.125583 17.863665 34.787806 44.944829a15.18475 15.18475 0 0 1-8.379545 8.252582c-29.963219 12.950205-133.18397 62.465694-159.846157 51.673857-15.578335-6.34814-21.113913-21.037735-16.632126-44.05609 50.188392-15.489461 100.211733-35.765419 150.070022-60.815178zM464.886964 487.879926l-222.057925-31.740698c-4.684927-0.64751-8.925484 0.177748-11.680577 2.28533-3.72001 2.882055-6.221177 6.855991-7.490805 11.934502l-6.34814-9.522209c-76.685527-91.413211 70.845239-60.053401 100.173644-45.706606 19.044419 9.306373 37.16201 16.3782 54.340076 21.202787a229.739175 229.739175 0 0 1 93.063727 51.546894z" fill="#357DA2" p-id="1738"></path><path d="M464.886964 487.879926c-7.617768 30.598033-8.125619 43.929126-33.899066 64.497099-38.088838 30.47107-67.074444 67.125229-86.969513 109.949779l-149.308245-31.232847 16.251237-109.949779 12.69628-50.785118c1.269628-5.078512 3.770795-9.052447 7.490805-11.934502 2.755093-2.107582 6.99565-2.932841 11.680577-2.28533l222.057925 31.740698z" fill="#1D4D59" p-id="1739"></path><path d="M217.309517 460.836851l6.34814 9.522209-12.69628 50.785118a121.693837 121.693837 0 0 1 6.34814-60.307327z" fill="#83ACB7" p-id="1740"></path><path d="M969.056216 547.044588l-241.102344 0.761776c-52.943485-30.090182-23.742042-59.291624 18.790493-58.783773 73.473369 0.926828 146.553152 0.761777 219.264744-0.507851 4.392913-0.088874 8.582685 1.015702 12.061466 3.17407 31.321721 19.387219 28.312703 37.834912-9.014359 55.355778zM568.615566 514.796038c10.157023 6.690939 20.910772 7.579679 32.24855 2.666219 155.402459 33.683229 226.463534 131.190654 213.17053 292.522276-9.738046 13.711982-10.956889 27.6398-3.681921 41.770759l-72.749681 85.699885c-2.52656 3.009018-2.158367 7.935175 0.88874 11.80754l43.802163 55.482741c2.323419 2.996322 2.107582 7.452716-0.507851 10.791837-20.314047 26.662187-54.720964-32.883363-68.813834-50.531192a8.1891 8.1891 0 0 0-9.776135-2.28533c-82.017964 36.946173-161.115785 45.960531-243.006786-1.396591a7.808212 7.808212 0 0 0-9.649173 1.777479c-8.252582 9.522209-61.196066 90.01662-74.019308 49.642453a12.315391 12.315391 0 0 1 2.28533-11.299689l45.198755-56.879331a7.109916 7.109916 0 0 0-0.380889-9.52221c-35.130605-35.460708-60.853267-77.15529-77.193378-125.058351 5.167386-12.277302 3.212159-23.018354-5.840289-32.24855 7.706642-147.187966 83.70657-234.843079 228.025177-262.939945z m191.586855 242.752861a179.652353 179.652353 0 1 0-359.304705 0c0 99.221423 80.43093 179.652353 179.652353 179.652353a179.652353 179.652353 0 0 0 179.652352-179.652353z" fill="#357DA2" p-id="1741"></path><path d="M969.056216 547.044588l3.17407 97.380462a681.663237 681.663237 0 0 0-159.211343 7.998656c-20.98695-37.16201-49.350438-72.025993-85.065071-104.617342l241.102344-0.761776z" fill="#1D4D59" p-id="1742"></path><path d="M194.71014 631.093957l149.308245 31.232847-13.965907 42.786461c-1.09188 3.250248-4.976941 5.053119-9.014359 4.189772a140.801738 140.801738 0 0 0-56.117554-0.888739c-8.887396-8.798522-19.641144-11.80754-32.24855-9.014358a203.597535 203.597535 0 0 0-29.455368-7.744731c-41.516833-7.74473-64.751025-36.311359-8.506507-60.561252zM972.230286 644.42505c30.217145 13.039079 34.698931 29.544242 13.458056 49.51549a20.301351 20.301351 0 0 1-11.045763 4.951548l-47.357122 6.34814c-11.515525-6.259266-20.948861-6.602065-28.312703-1.015702l-59.164661-2.920144c-5.002334-0.228533-9.027055-2.298027-10.157024-5.205475l-16.632126-43.675201a681.663237 681.663237 0 0 1 159.211343-7.998656z" fill="#357DA2" p-id="1743"></path><path d="M232.672015 699.39994c12.607405-2.793181 23.361154 0.215837 32.24855 9.014358-3.808884 21.8376-2.323419 42.875335 4.443697 63.100508 1.29502 3.732706 4.71032 6.221177 8.506507 6.221177h62.71962c9.052447 9.230195 11.007674 19.971247 5.840289 32.24855l-74.019309-1.650517c-25.049759-0.596725-37.834912-14.130959-38.342763-40.628094l-1.396591-68.305982zM927.285457 705.240228c17.26694 79.224783-63.100508 112.615998-116.932732 146.515064-7.274968-14.130959-6.056125-28.058777 3.681921-41.770759 52.65147-17.863665 80.964173-53.108536 84.938108-105.760007 7.363842-5.586363 16.797178-5.243563 28.312703 1.015702z" fill="#265360" p-id="1744"></path><path d="M580.550069 757.548899m-179.652353 0a179.652353 179.652353 0 1 0 359.304705 0 179.652353 179.652353 0 1 0-359.304705 0Z" fill="#FFC133" p-id="1745"></path></svg>
            <span class="text-xs font-semibold text-gray-700 mt-1">鼓</span>
          </div>
          
          <!-- 低音图标 -->
          <div v-else-if="name === 'bass'" class="flex flex-col items-center">
            <svg class="w-8 h-8 text-gray-700" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1910" width="200" height="200"><path d="M821.166326 286.379778l-53.55975-62.088373c-3.866309-16.033811-41.051104-43.325403-20.12755-52.422601 3.286363-1.36458 7.118557-1.023435 10.348062 0.90972 6.709183 3.866309 41.619679 36.729935 43.780264 17.170961 0.352516-3.024818-1.068921-6.618211-3.866309-9.779488-6.481753-7.164043-40.709959-40.255099-10.461778-44.007693 3.184019-0.432117 6.822898 0.807376 10.006918 3.411449 4.093739 3.411449 32.408766 33.887061 36.84365 17.057246 0.773262-2.911103-0.375259-6.663697-3.070304-10.006918l-20.696125-25.699583c-2.547215-3.11579-3.456935-6.936613-2.388014-10.120632 10.575492-32.636196 67.319262 42.301969 61.974658 8.528623-1.13715-7.618903-19.90012-25.358438-25.244723-33.204771-2.331157-3.377335-2.979332-7.300501-1.705725-10.348063 13.986941-33.204771 60.610079 43.552833 61.064939 12.167502 0.068229-2.12647-1.626124-5.742606-4.548599-9.665772l-21.150984-28.656172a9.381485 9.381485 0 0 1-0.568575-10.234348c15.920096-27.405308 52.650031 43.666548 59.245499 14.896661 0.636804-2.695045-0.68229-6.413524-3.525164-9.893202l-21.037269-25.699583c-2.478986-3.03619-3.34322-6.822898-2.2743-10.006917 8.756053-27.177878 51.512881 17.39839 62.429518 25.131008 3.274991 2.331157 5.435576 5.481062 6.026894 8.756052l9.779487 56.402625c0.579946 3.297734-0.22743 7.0617-2.274299 10.575492l-86.764522 148.170605c-4.275683 7.323244-12.224359 12.804306-21.946989 15.124091l-56.28891 13.532081z" fill="#357DA2" p-id="1911"></path><path d="M767.606576 224.291405l53.55975 62.088373-267.116462 279.39768-36.84365 35.592785c-13.793626 13.270537-25.699583 14.248486-35.706501 2.956589l-41.505964-46.736852c-4.036881-4.571342-3.002075-12.429046 2.388015-18.08068l91.426835-95.634289c82.215923-63.111808 158.632382-147.033455 233.797977-219.583606z" fill="#1D4D59" p-id="1912"></path><path d="M533.808599 443.875011l-91.426835 95.634289c-5.39009 5.651634-6.424896 13.509338-2.388015 18.08068l41.505964 46.736852c10.006917 11.291896 21.912875 10.313948 35.706501-2.956589l36.84365-35.592785c10.837037 45.178957 36.275075 69.138701 76.302744 71.86786 2.649559 0.147829 6.220209-0.68229 10.689207-2.501729l50.034586-20.696124c3.070304-1.21675 6.891127-0.659547 10.234348 1.478294 28.280913 18.501425 31.874306 41.278534 10.802922 68.342697-27.439422 35.331241-68.035666 53.218606-121.788732 53.673465-3.786708 0-7.414216 1.023435-10.461777 2.956589-80.623913 51.171736-57.653489 172.619323-122.925882 238.232861-71.413001 71.640431-199.910916 47.646572-276.327375-3.411449-109.052655-72.891295-201.275496-253.129521-104.504057-369.914795 80.169053-96.430294 241.87174-48.101432 290.655461-177.054207 21.037269-55.60662 27.291593-89.379966 88.129101-126.905906 23.880144-14.703346 48.704121-13.043107 74.483305 5.003459a5.685748 5.685748 0 0 1 1.36458 7.960048c-31.953906 46.623137-76.075314 90.175971 3.070304 129.06649z m-47.532857 261.612658a13.645796 13.645796 0 0 0-0.056858-19.29743L367.762001 568.574846a13.645796 13.645796 0 0 0-19.29743 0.068229l-0.477603 0.488974a13.645796 13.645796 0 0 0 0.068229 19.297431l118.445512 117.626764a13.645796 13.645796 0 0 0 19.308802-0.068229l0.477602-0.488975zM311.143318 624.693183a13.304651 13.304651 0 0 0-18.808456 0l-0.488974 0.488975a13.304651 13.304651 0 0 0 0 18.808456l118.036138 118.036138a13.304651 13.304651 0 0 0 18.819827 0l0.488974-0.477603a13.304651 13.304651 0 0 0 0-18.808456l-118.036138-118.036138z m-79.122876 89.038821a6.822898 6.822898 0 0 0-9.643029-0.011371l-33.1934 33.068313a6.822898 6.822898 0 0 0-0.011371 9.654401l109.484772 109.860031a6.822898 6.822898 0 0 0 9.64303 0.022743l33.193399-33.068313a6.822898 6.822898 0 0 0 0.011372-9.654401l-109.484773-109.871403z" fill="#357DA2" p-id="1913"></path><path d="M358.08447 558.950601m9.682658 9.615294l118.45118 117.627108q9.682658 9.615295 0.067363 19.297953l-0.480765 0.484133q-9.615295 9.682658-19.297953 0.067362l-118.451179-117.627107q-9.682658-9.615295-0.067363-19.297953l0.480764-0.484133q9.615295-9.682658 19.297953-0.067363Z" fill="#FFC133" p-id="1914"></path><path d="M282.43021 634.586948m9.40781-9.407809l0.482451-0.482452q9.407809-9.407809 18.815619 0l118.039862 118.039863q9.407809 9.407809 0 18.815618l-0.482451 0.482452q-9.407809 9.407809-18.815619 0l-118.039862-118.039863q-9.407809-9.407809 0-18.815618Z" fill="#FFC133" p-id="1915"></path><path d="M184.342587 751.607467m4.832931-4.81609l33.186123-33.070483q4.832931-4.81609 9.64902 0.016841l109.485776 109.868621q4.81609 4.832931-0.016841 9.649021l-33.186123 33.070483q-4.832931 4.81609-9.649021-0.01684l-109.485775-109.868622q-4.81609-4.832931 0.016841-9.649021Z" fill="#FFC133" p-id="1916"></path></svg>
            <span class="text-xs font-semibold text-gray-700 mt-1">低音</span>
          </div>
          
          <!-- 其他乐器图标 -->
          <div v-else-if="name === 'other'" class="flex flex-col items-center">
            <svg class="w-8 h-8 text-gray-700" viewBox="0 0 1356 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2438" width="200" height="200"><path d="M241.453091 0.244393l-4.429631 52.850084-232.326523 19.704222c-12.525164-42.371714 0-65.2836 37.575493-68.735658 36.353526-3.36041 102.752171-4.643476 199.180661-3.818648z" fill="#FFC133" p-id="2439"></path><path d="M241.453091 0.244393l78.511396 0.916476a8.401025 8.401025 0 0 1 8.401024 7.790041l3.513156 37.117255 1.221968 675.900634-5.498853 39.408444a9.622992 9.622992 0 0 1-9.470246 8.248279l-77.289429 1.374713-4.429631-52.850083 3.36041-76.525699c2.657779-17.214464 1.939873-31.160165-2.138443-41.852379 7.637295-25.462743 7.240156-50.925485-1.221967-76.372953 6.72082-14.266468 6.72082-28.257993 0-42.005124 11.608689-24.958681 10.539468-49.336928-3.207664-73.165289 10.295074-15.381513 11.364295-31.725325 3.207664-49.031435 5.605775-24.240775 5.804344-48.634296 0.610984-73.165289 11.608689-26.791632 2.703603-42.9216-26.730534-48.420453 47.962214 9.775738 33.756845-38.339222 26.11955-65.527993 7.438726-17.825447 6.323681-32.290485-3.36041-43.379838 10.997705-26.073726 12.326595-51.276801 3.971394-75.609223l4.429631-52.850084z" fill="#357DA2" p-id="2440"></path><path d="M427.344859 60.579026a7141.802855 7141.802855 0 0 0-50.100658 683.385184c-15.977222 10.692213-30.701927 3.36041-44.143566-21.995411l-1.221968-675.900634c32.901468-29.541058 64.71844-24.699013 95.466192 14.510861z" fill="#FFC133" p-id="2441"></path><path d="M513.967062 66.994354a12724.589346 12724.589346 0 0 1-99.284839 688.73129c-1.13032 13.533287-13.594386 9.622992-37.422747-11.761434 5.804344-229.118859 22.499472-456.924103 50.100657-683.385184 31.465657-31.068517 60.334633-28.930075 86.606929 6.415328z" fill="#F4893B" p-id="2442"></path><path d="M237.038734 53.094477c8.339926 24.332423 7.026312 49.535497-3.971393 75.609223L4.712211 107.166528v-34.367829l232.326523-19.704222z" fill="#1D4D59" p-id="2443"></path><path d="M629.137475 97.543536c-57.737952 206.817957-111.810003 414.705135-162.216152 623.661534-7.942787 33.145862-0.916475 56.057747 29.785451 70.110371-28.823152-2.138443-56.16467-14.0068-82.024551-35.589797a12724.589346 12724.589346 0 0 0 99.284839-688.73129c13.838779 5.285008 34.917714 4.124139 63.236805-3.513155a10.463095 10.463095 0 0 1 11.455943 4.276885c14.052623 20.559599 27.540087 30.488083 40.477665 29.785452z" fill="#FFC133" p-id="2444"></path><path d="M717.424609 141.687102l-209.261892 644.587724-11.455943 5.040615c-30.701927-14.052623-37.728239-36.964509-29.785451-70.110371 50.406149-208.956399 104.4782-416.843577 162.216152-623.661534 52.025256-20.987287 81.459392-6.262582 88.287134 44.143566z" fill="#F4893B" p-id="2445"></path><path d="M233.067341 128.7037c9.668816 11.089353 10.783861 25.55439 3.36041 43.379838-113.551307 6.415328-183.356186 11.501767-209.414637 15.27459-12.830656 1.832951-20.269382 12.005828-22.300903 30.549181-6.109836-36.964509-6.109836-73.883195 0-110.740781l228.35513 21.537172zM813.639255 165.057226l-255.849393 640.310838c-20.467951 3.971394-37.010333-2.398111-49.642419-19.093238l209.261891-644.587724c19.96389-14.571959 40.279095-20.987287 60.945617-19.245984 4.200512 0.244393 7.896963 3.696451 9.164754 8.553771 3.772824 14.862177 12.479341 26.211197 26.11955 34.062337z" fill="#FFC133" p-id="2446"></path><path d="M882.985896 160.627595c-1.924598 18.635001 5.498853 31.160165 22.300902 37.575493l3.818648 3.818647c-21.537173 23.52287-29.938198 61.709346-40.172173 82.635535-80.344347 165.576562-160.581771 331.198948-240.727548 496.882433-9.974308 20.666521-24.530993 34.978812-43.685329 42.921599-16.191066 3.864471-25.096152-2.505033-26.730534-19.093238l255.849393-640.310838c23.12573-10.600566 46.236186-12.066927 69.346641-4.429631z" fill="#F4893B" p-id="2447"></path><path d="M882.985896 160.627595l22.300902 37.575493c-16.80205-6.415328-24.225501-18.940492-22.300902-37.575493z" fill="#F8DF9D" p-id="2448"></path><path d="M236.412476 172.083538c7.637295 27.188771 21.842665 75.303732-26.11955 65.527993l-205.595989-12.066926v-7.637296c2.046795-18.543353 9.470246-28.71623 22.300902-30.549181 26.073726-3.772824 95.878605-8.859263 209.414637-15.27459z" fill="#1D4D59" p-id="2449"></path><path d="M1023.664876 249.067474l-7.179058 2.138443c-4.719848 1.374713-8.706517 4.368533-11.150451 8.401025l-356.508945 588.37723-64.306026-23.52287c19.154337-7.942787 33.711021-22.255079 43.685329-42.921599 80.145777-165.683484 160.383201-331.30587 240.727548-496.882433 10.233976-20.926189 18.635001-59.112666 40.172173-82.635535l56.821477-2.902172a12.341869 12.341869 0 0 1 11.455943 6.109836l17.107541 31.771149c2.749426 5.162812 6.445877 8.859263 10.233976 10.233975 5.804344 2.138443 12.128025 2.749426 18.940493 1.832951zM210.308201 237.611531c29.418861 5.498853 38.339222 21.62882 26.730533 48.420453-62.534174 9.164754-125.358565 15.47316-188.488448 18.940492-46.434755 2.443934-55.59951 41.088649-7.331803 44.143567 65.069756 4.063041 130.139512 7.423451 195.209268 10.08123 8.141357 17.306111 7.072135 33.649923-3.207664 49.031435-75.868892 0.19857-150.760209 8.034435-224.689228 23.52287l-3.818648-206.206973 205.59599 12.066926z" fill="#FFC133" p-id="2450"></path><path d="M1093.026791 301.917558l-401.568986 561.952188-42.616108-15.885574 356.508944-588.37723c2.443934-4.032492 6.415328-7.026312 11.150452-8.401025l7.179057-2.138443c43.578407-11.211549 66.688863 6.415328 69.346641 52.850084z" fill="#F4893B" p-id="2451"></path><path d="M237.038734 286.031984c5.193361 24.530993 4.979517 48.924514-0.610983 73.165289a8945.869476 8945.869476 0 0 1-195.209268-10.08123c-48.267706-3.054918-39.102952-41.699632 7.331803-44.143567 63.129883-3.467332 125.954274-9.775738 188.488448-18.940492z" fill="#1D4D59" p-id="2452"></path><path d="M1184.048077 348.352313l-442.963128 523.154728-49.642419-7.637295 401.568987-561.952188 57.585206-1.374713c4.185238-0.122197 8.049709 3.16184 9.317501 7.942787a77.564371 77.564371 0 0 0 24.133853 39.866681z" fill="#FFC133" p-id="2453"></path><path d="M1299.233765 527.217769c-45.823772-30.243689-93.327749-75.303732-143.27566-16.649304a24990.146696 24990.146696 0 0 0-261.653737 313.281854c-16.60348 20.16246-19.245984 42.050948-7.942787 65.680739 9.561894 20.055537 28.609308 40.783157 57.126968 62.167584-18.543353 26.776357-41.913477 50.192305-70.11037 70.263117a11.226824 11.226824 0 0 1-12.677911 0.152746c-47.458153-31.160165-89.463277-66.749961-126.015372-106.769389-3.604803-3.895021-5.453029-8.721791-5.040615-13.288894 0.809553-11.303197 4.628201-21.491349 11.455943-30.549181l442.963127-523.154728c6.308406-12.433517 16.847873-19.307083 31.618403-20.620697 4.506004-0.504061 9.454972 0.916475 13.899877 3.971393a712.147238 712.147238 0 0 1 123.265947 105.394676c3.238213 3.406234 4.124139 8.401025 2.291188 12.67791-13.0445 30.747751-31.679501 56.561809-55.905001 77.442174z" fill="#357DA2" p-id="2454"></path><path d="M233.220087 408.228708c13.747132 23.828361 14.816353 48.206608 3.207664 73.165289l-228.507876-23.675615 0.610984-25.966804a1108.11045 1108.11045 0 0 1 224.689228-23.52287z" fill="#1D4D59" p-id="2455"></path><path d="M7.904601 457.718382l228.507875 23.675615c6.72082 13.747132 6.72082 27.738657 0 42.005124l-227.896892 22.911886c-6.812467-32.183562-7.026312-61.709346-0.610983-88.592625z" fill="#FFC133" p-id="2456"></path><path d="M1299.233765 527.217769l-355.745216 424.480873c-28.517661-21.384427-47.565075-42.112046-57.126968-62.167584-11.303197-23.629792-8.660693-45.51828 7.942787-65.680739a24990.146696 24990.146696 0 0 1 261.653737-313.281854c49.947911-58.654428 97.451888-13.594386 143.27566 16.649304zM236.412476 523.399121c8.462123 25.447468 8.859263 50.91021 1.221967 76.372953l-229.729842-19.704221 0.610983-33.756846 227.896892-22.911886z" fill="#1D4D59" p-id="2457"></path><path d="M237.634443 599.772074c4.078316 10.692213 4.796221 24.637915 2.138443 41.852379l-231.257302 23.064632a177.490743 177.490743 0 0 1-0.610983-84.621232l229.729842 19.704221z" fill="#FFC133" p-id="2458"></path><path d="M239.772886 641.624453l-3.36041 76.525699-224.689228-26.272296-3.207664-27.188771z" fill="#1D4D59" p-id="2459"></path><path d="M11.723248 691.877856l224.689228 26.272296 4.429631 52.850083c-41.546886 0.305492-200.249883 8.706517-225.911195-20.009714-14.358115-15.992496-15.427337-35.696718-3.207664-59.112665z" fill="#FFC133" p-id="2460"></path></svg>
            <span class="text-xs font-semibold text-gray-700 mt-1">其他乐器</span>
          </div>
          
          <!-- 人声图标 -->
          <div v-else-if="name === 'vocals'" class="flex flex-col items-center">
            <svg class="w-8 h-8 text-gray-700"  viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3717" width="200" height="200"><path d="M1024 512c0 282.737778-229.262222 512-512 512s-512-229.262222-512-512 229.262222-512 512-512 512 229.262222 512 512" fill="#ffffff" p-id="3718" data-spm-anchor-id="a313x.collections_detail.0.i28.323e3a81XVkeKx" class=""></path><path d="M526.791111 792.462222L557.511111 398.222222H386.844444l30.72 394.24c2.275556 27.875556 26.168889 49.493333 54.613334 49.493334 29.013333 0 52.337778-21.617778 54.613333-49.493334M322.56 250.311111c-2.844444 10.808889-3.982222 21.617778-3.982222 32.995556 0 47.786667 25.031111 89.884444 63.146666 114.915555h169.528889C589.368889 372.622222 614.4 330.524444 614.4 282.737778c0-11.377778-1.706667-22.186667-3.982222-32.995556-43.804444 7.395556-92.16 11.377778-143.928889 11.377778s-100.124444-3.982222-143.928889-10.808889" fill="#ffc133" p-id="3719" data-spm-anchor-id="a313x.collections_detail.0.i31.323e3a81XVkeKx" class=""></path><path d="M460.8 136.533333c-68.835556 0-126.862222 48.355556-142.222222 113.208889 43.235556 7.395556 91.591111 11.946667 142.222222 11.946667s98.986667-4.551111 142.222222-11.946667c-15.36-64.853333-73.386667-113.208889-142.222222-113.208889" fill="#f4893b" p-id="3720" data-spm-anchor-id="a313x.collections_detail.0.i29.323e3a81XVkeKx" class=""></path><path d="M449.422222 830.577778c-34.702222 0-63.715556-26.168889-65.991111-60.302222L352.711111 376.035556c0-3.413333 0.568889-6.257778 2.844445-8.533334s5.12-3.413333 8.533333-3.413333h170.666667c3.413333 0 6.257778 1.137778 8.533333 3.413333s3.413333 5.688889 2.844444 8.533334l-30.72 394.24c-2.275556 33.564444-31.288889 60.302222-65.991111 60.302222z m-72.817778-443.733334l29.582223 381.724445c1.706667 21.617778 20.48 39.253333 43.235555 39.253333 22.755556 0 41.528889-17.066667 43.235556-39.253333l29.582222-381.724445H376.604444z" fill="#357da2" p-id="3721" data-spm-anchor-id="a313x.collections_detail.0.i33.323e3a81XVkeKx" class=""></path><path d="M528.497778 386.844444H358.4c-2.275556 0-4.551111-0.568889-6.257778-1.706666-42.666667-28.444444-67.697778-75.093333-67.697778-124.586667 0-11.377778 1.706667-23.324444 4.551112-35.271111 1.706667-5.688889 6.826667-9.671111 13.084444-8.533333 44.373333 7.395556 92.16 11.377778 141.653333 11.377777s97.28-3.982222 141.653334-11.377777c5.688889-1.137778 11.377778 2.844444 13.084444 8.533333 2.844444 11.946667 4.551111 23.893333 4.551111 35.271111 0 49.493333-25.6 96.142222-67.697778 124.586667-2.275556 1.137778-4.551111 1.706667-6.826666 1.706666z m-166.115556-22.755555h162.702222C559.786667 339.626667 580.266667 300.942222 580.266667 259.982222c0-6.257778-0.568889-13.084444-1.706667-19.911111-42.666667 6.826667-88.177778 10.24-134.826667 10.24s-92.16-3.413333-134.826666-9.671111c-1.137778 6.826667-1.706667 13.084444-1.706667 19.911111 0 40.391111 20.48 79.075556 55.182222 103.537778z" fill="#357da2" p-id="3722" data-spm-anchor-id="a313x.collections_detail.0.i34.323e3a81XVkeKx" class=""></path><path d="M438.044444 250.311111c-50.062222 0-98.986667-3.982222-143.928888-11.946667-2.844444-0.568889-5.688889-2.275556-7.395556-5.12s-2.275556-5.688889-1.706667-9.102222C301.511111 152.462222 364.657778 102.4 438.044444 102.4c73.386667 0 136.533333 50.062222 153.031112 122.311111 0.568889 2.844444 0 6.257778-1.706667 9.102222s-4.551111 4.551111-7.395556 5.12c-44.942222 7.395556-93.866667 11.377778-143.928889 11.377778z m-128-32.426667c40.391111 6.257778 83.626667 9.671111 128 9.671112 44.373333 0 87.608889-3.413333 128-9.671112-18.204444-55.182222-69.404444-92.728889-128-92.728888s-109.795556 37.546667-128 92.728888z" fill="#357da2" p-id="3723" data-spm-anchor-id="a313x.collections_detail.0.i35.323e3a81XVkeKx" class=""></path><path d="M432.355556 409.6h22.755555v56.888889h-22.755555z" fill="#9D4CE8" p-id="3724"></path><path d="M519.964444 921.6c-48.355556 0-87.608889-39.822222-87.608888-88.746667v-14.791111h22.755555v14.791111c0 36.408889 29.013333 65.991111 64.853333 65.991111s64.853333-29.582222 64.853334-65.991111V596.195556c0-46.648889 37.546667-84.195556 83.057778-84.195556S750.933333 549.546667 750.933333 596.195556v258.844444h-22.755555V596.195556c0-34.133333-27.306667-61.44-60.302222-61.44S607.573333 562.631111 607.573333 596.195556v236.657777c-0.568889 48.924444-39.822222 88.746667-87.608889 88.746667z" fill="#357da2" p-id="3725" data-spm-anchor-id="a313x.collections_detail.0.i32.323e3a81XVkeKx" class=""></path></svg>
            <span class="text-xs font-semibold text-gray-700 mt-1">人声</span>
          </div>
          
          <!-- 默认图标 -->
          <div v-else class="flex flex-col items-center">
            <svg class="w-8 h-8 text-gray-700" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
            </svg>
            <span class="text-xs font-semibold text-gray-700 mt-1">{{ waveNameMap[name] || name }}</span>
          </div>
        </div>
        <div class="flex-1 relative">
          <!-- 进度条 - 在播放时或点击波形时显示 -->
          <div 
            v-show="isPlaying || progressBarPosition > 0" 
            class="absolute top-0 bottom-0 w-1 bg-blue-500 z-10 transition-all duration-100 shadow-lg"
            :style="{ left: progressBarPosition + 'px' }"
          >
            <div v-if="name === 'drums'" class="absolute -top-1 -left-1 w-3 h-3 bg-blue-500 rounded-full shadow-md"></div>
          </div>
          
          <canvas 
            :ref="'waveform-' + name" 
            class="h-20 waveform-canvas w-full cursor-pointer rounded-none" 
            :style="{ background: waveBgMap[name]}"
            @click="onWaveformClick($event, name)"
          ></canvas>
        </div>
      </div>
    </div>

    <!-- 控制按钮 -->
    <div class="absolute bottom-4 left-4 flex gap-2 z-20" v-show="showControls">
      <button 
        @click="togglePlay"
        class="bg-blue-500 w-14 h-14 text-white rounded-full hover:drop-shadow-xl transition-colors">
        <svg v-if="!isPlaying" class="w-14 h-14" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1304" width="200" height="200"><path d="M505.806452 509.935484m-476.775226 0a476.775226 476.775226 0 1 0 953.550451 0 476.775226 476.775226 0 1 0-953.550451 0Z" fill="#D2F095" p-id="1305"></path><path d="M422.247226 368.59871c0-22.709677 15.215484-30.625032 33.808516-17.585549l199.824516 140.106323c18.597161 13.035355 18.597161 34.374194 0 47.409548l-199.824516 140.102194c-18.593032 13.039484-33.808516 5.12-33.808516-17.589678V368.59871z" fill="#FFFFFF" p-id="1306"></path><path d="M439.320774 705.560774c-18.167742 0-37.71871-13.931355-37.718709-44.519226V368.59871c0-30.583742 19.550968-44.515097 37.718709-44.515097 9.480258 0 19.100903 3.373419 28.585291 10.02529l199.820387 140.106323c14.451613 10.128516 22.74271 24.931097 22.742709 40.604903 0 15.677935-8.291097 30.480516-22.742709 40.613161l-199.820387 140.098065c-9.484387 6.656-19.100903 10.029419-28.585291 10.029419z m3.612903-338.485677c-0.024774 0.462452-0.04129 0.970323-0.04129 1.523613v292.442838c0 0.557419 0.012387 1.06529 0.04129 1.527742 0.392258-0.247742 0.813419-0.524387 1.267613-0.842322l199.828645-140.102194c3.179355-2.229677 5.153032-4.835097 5.153033-6.800516s-1.977806-4.570839-5.153033-6.796387l-199.824516-140.110452a27.883355 27.883355 0 0 0-1.271742-0.842322z" fill="#6E6E96" p-id="1307"></path><path d="M502.511484 967.461161c-263.349677 0-477.601032-215.613935-477.601032-480.635871S239.161806 6.193548 502.511484 6.193548s477.601032 215.609806 477.601032 480.631742-214.251355 480.635871-477.601032 480.635871z m0-919.97729c-240.582194 0-436.31071 197.086968-436.31071 439.341419 0 242.254452 195.728516 439.345548 436.31071 439.345549s436.31071-197.086968 436.31071-439.345549c0-242.254452-195.728516-439.341419-436.31071-439.341419z" opacity=".1" p-id="1308"></path><path d="M1007.351742 536.369548h-41.290323c0-242.250323-204.618323-439.33729-456.125935-439.33729S53.809548 294.119226 53.809548 536.369548h-41.290322C12.519226 271.351742 235.660387 55.741935 509.935484 55.741935s497.416258 215.609806 497.416258 480.627613z" fill="#FFFFFF" opacity=".49" p-id="1309"></path><path d="M505.806452 53.809548c251.507613 0 456.125935 204.618323 456.125935 456.125936 0 251.511742-204.618323 456.130065-456.125935 456.130064S49.680516 761.447226 49.680516 509.935484 254.298839 53.809548 505.806452 53.809548zM8.390194 509.935484c0 274.279226 223.141161 497.420387 497.416258 497.420387S1003.22271 784.21471 1003.22271 509.935484c0-274.275097-223.141161-497.416258-497.416258-497.416258S8.390194 235.660387 8.390194 509.935484z" fill="#6E6E96" p-id="1310"></path></svg>
        <svg v-else class="w-14 h-14" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1304" width="200" height="200"><path d="M505.806452 509.935484m-476.775226 0a476.775226 476.775226 0 1 0 953.550451 0 476.775226 476.775226 0 1 0-953.550451 0Z" fill="#FFA1B5" p-id="1305"></path><path d="M502.511484 967.461161c-263.349677 0-477.601032-215.613935-477.601032-480.635871S239.161806 6.193548 502.511484 6.193548s477.601032 215.609806 477.601032 480.631742-214.251355 480.635871-477.601032 480.635871z m0-919.97729c-240.582194 0-436.31071 197.086968-436.31071 439.341419 0 242.254452 195.728516 439.345548 436.31071 439.345549s436.31071-197.086968 436.31071-439.345549c0-242.254452-195.728516-439.341419-436.31071-439.341419z" opacity=".1" p-id="1306"></path><path d="M1007.351742 536.369548h-41.290323c0-242.250323-204.618323-439.33729-456.125935-439.33729S53.809548 294.119226 53.809548 536.369548h-41.290322C12.519226 271.351742 235.660387 55.741935 509.935484 55.741935s497.416258 215.609806 497.416258 480.627613z" fill="#FFFFFF" opacity=".49" p-id="1307"></path><path d="M505.806452 53.809548c251.507613 0 456.125935 204.618323 456.125935 456.125936 0 251.511742-204.618323 456.130065-456.125935 456.130064S49.680516 761.447226 49.680516 509.935484 254.298839 53.809548 505.806452 53.809548zM8.390194 509.935484c0 274.283355 223.141161 497.420387 497.416258 497.420387S1003.22271 784.218839 1003.22271 509.935484c0-274.275097-223.141161-497.416258-497.416258-497.416258S8.390194 235.660387 8.390194 509.935484z" fill="#6E6E96" p-id="1308"></path><path d="M683.354839 633.806452c0 22.709677-18.580645 41.290323-41.290323 41.290322h-247.741935c-22.709677 0-41.290323-18.580645-41.290323-41.290322v-247.741936c0-22.709677 18.580645-41.290323 41.290323-41.290322h247.741935c22.709677 0 41.290323 18.580645 41.290323 41.290322v247.741936z" fill="#FFFFFF" p-id="1309"></path><path d="M662.709677 633.806452c0 11.383742-9.261419 20.645161-20.645161 20.645161h-247.741935c-11.383742 0-20.645161-9.261419-20.645162-20.645161v-247.741936c0-11.383742 9.261419-20.645161 20.645162-20.645161h247.741935c11.383742 0 20.645161 9.261419 20.645161 20.645161v247.741936z m41.290323-247.741936c0-34.151226-27.784258-61.935484-61.935484-61.935484h-247.741935c-34.151226 0-61.935484 27.784258-61.935484 61.935484v247.741936c0 34.151226 27.784258 61.935484 61.935484 61.935483h247.741935c34.151226 0 61.935484-27.784258 61.935484-61.935483v-247.741936z" fill="#6E6E96" p-id="1310"></path></svg>
      </button>
      
      <button 
        @click="downloadAll"
        class="p-2 bg-zinc-200 text-white rounded-full border-4 border-[#6e6e96] hover:bg-green-400 hover:drop-shadow-xl transition-colors">
        <svg class="w-8 h-8" fill="none" stroke="#6e6e96" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
        </svg>
      </button>
      <button 
        @click="deleteAll"
        class="p-2 bg-zinc-200 text-white rounded-full border-4 border-[#6e6e96] hover:bg-[#ffa3b7] hover:drop-shadow-xl transition-colors">
        <svg class="w-8 h-8" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1244" data-spm-anchor-id="a313x.collections_detail.0.i0.dbd33a815bxC6Y" width="200" height="200"><path d="M960 218.24A96 96 0 0 0 864 128h-96V96a96 96 0 0 0-96-96H352a96 96 0 0 0-96 96v32H160a96 96 0 0 0-96 90.24V288a64 64 0 0 0 64 64v544a128 128 0 0 0 128 128h512a128 128 0 0 0 128-128V352a64 64 0 0 0 64-64V218.24zM320 96a32 32 0 0 1 32-32h320a32 32 0 0 1 32 32v32H320z m512 800a64 64 0 0 1-64 64H256a64 64 0 0 1-64-64V352h640z m64-640v32H128V224a32 32 0 0 1 32-32h704a32 32 0 0 1 32 32z" fill="#6e6e96" p-id="1245" data-spm-anchor-id="a313x.collections_detail.0.i3.dbd33a815bxC6Y" class=""></path><path d="M288 896h64a32 32 0 0 0 32-32V448a32 32 0 0 0-32-32H288a32 32 0 0 0-32 32v416a32 32 0 0 0 32 32z m0-448h64v416H288zM480 896h64a32 32 0 0 0 32-32V448a32 32 0 0 0-32-32h-64a32 32 0 0 0-32 32v416a32 32 0 0 0 32 32z m0-448h64v416h-64zM672 896h64a32 32 0 0 0 32-32V448a32 32 0 0 0-32-32h-64a32 32 0 0 0-32 32v416a32 32 0 0 0 32 32z m0-448h64v416h-64z" fill="#6e6e96" p-id="1246" data-spm-anchor-id="a313x.collections_detail.0.i1.dbd33a815bxC6Y" class=""></path></svg>
      </button>
    </div>
  </div>
</template>

<script>
import { push } from 'notivue'

export default {
  name: 'AudioWaveformPlayer',
  props: {
    audioBuffers: {
      type: Object,
      default: () => ({})
    },
    waveNameMap: {
      type: Object,
      default: () => ({
        'drums': '鼓',
        'bass': '低音',
        'other': '其他乐器',
        'vocals': '人声'
      })
    },
    waveBgMap: {
      type: Object,
      default: () => ({
        'drums': '#e8e7d2',
        'bass': '#d2d5b8',
        'other': '#bdc2bb',
        'vocals': '#c9ba9b'
      })
    },
    waveColorMap: {
      type: Object,
      default: () => ({
        'drums': '#57534e',
        'bass': '#f59e0b',
        'other': '#84cc16',
        'vocals': '#06b6d4'
      })
    },
    title: {
      type: String,
      default: '音频波形'
    },
    subtitle: {
      type: String,
      default: '点击下方按钮播放或下载音轨'
    },
    showTitle: {
      type: Boolean,
      default: true
    },
    showControls: {
      type: Boolean,
      default: true
    },
    originalFileName: {
      type: String,
      default: ''
    }
  },
  data() {
    return {
      isPlaying: false,
      currentAudio: null,
      progressBarPosition: 0,
      audioStartTime: 0,
      audioDuration: 0,
      progressUpdateInterval: null,
      currentSeekTime: 0
    }
  },
  watch: {
    audioBuffers: {
      handler(newBuffers) {
        if (Object.keys(newBuffers).length > 0) {
          const firstBuffer = newBuffers[Object.keys(newBuffers)[0]];
          this.audioDuration = firstBuffer.duration;
          this.$nextTick(() => {
            this.drawAllWaveforms();
          });
        }
      },
      immediate: true
    }
  },
  methods: {
    drawWaveform(buffer, canvasRef) {
      const canvas = this.$refs[canvasRef][0];
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      // 获取父容器总宽度并减去左侧固定宽度w-32（128px）
      const parentWidth = canvas.parentElement.parentElement.offsetWidth;
      const availableWidth = parentWidth - 128; // 128px是左侧标题容器的宽度
      
      // 设置canvas尺寸
      const width = canvas.width = availableWidth * 2;
      canvas.style.width = availableWidth + 'px'; // 实际显示宽度
      const height = canvas.height = 80;
      
      ctx.clearRect(0, 0, canvas.width, height);
      
      // 降采样显示（每100个采样点取一个）
      const channelData = buffer.getChannelData(0);
      const step = Math.ceil(channelData.length / 2000);
      const points = [];
      
      for (let i = 0; i < channelData.length; i += step) {
        points.push(channelData[i]);
      }
  
      ctx.beginPath();
      ctx.moveTo(0, height/2);
      const trackName = canvasRef.split('-')[1];
      ctx.strokeStyle = this.waveColorMap[trackName] || '#000000';
      ctx.lineWidth = 2;
  
      points.forEach((val, i) => {
        const x = (i / points.length) * width; // 使用canvas实际宽度
        const y = (val * height/2) + height/2;
        ctx.lineTo(x, y);
      });

      ctx.stroke();
    },

    drawAllWaveforms() {
      Object.keys(this.audioBuffers).forEach(name => {
        const canvasRef = 'waveform-' + name;
        if (this.$refs[canvasRef] && this.$refs[canvasRef][0]) {
          this.drawWaveform(this.audioBuffers[name], canvasRef);
        }
      });
    },

    togglePlay() {
      if (this.isPlaying) {
        this.stopPlay();
      } else {
        this.startPlay();
      }
    },

    startPlay() {
      try {
        if (this.currentAudio) {
          this.stopPlay();
        }
        
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const sources = [];
        
        // 获取当前选中的播放位置
        const startTime = this.currentSeekTime || 0;
        
        // 创建所有音轨的音频源
        Object.entries(this.audioBuffers).forEach(([name, buffer]) => {
          const source = audioContext.createBufferSource();
          source.buffer = buffer;
          source.connect(audioContext.destination);
          sources.push(source);
        });
        
        // 从指定位置开始播放所有音轨
        sources.forEach(source => source.start(0, startTime));
        
        this.currentAudio = sources;
        this.isPlaying = true;
        this.audioStartTime = (Date.now() / 1000) - startTime;
        
        // 启动进度条更新
        this.progressUpdateInterval = setInterval(() => {
          this.updateProgressBar();
        }, 50); // 每50ms更新一次
        
        this.$emit('play-start');
      } catch (error) {
        console.error('播放失败:', error);
        push.error({
          title: '播放失败',
          description: error.message,
          duration: 3000,
        });
      }
    },

    stopPlay() {
      if (this.currentAudio) {
        if (Array.isArray(this.currentAudio)) {
          this.currentAudio.forEach(source => {
            if (source.stop) {
              source.stop();
            }
          });
        } else {
          this.currentAudio.stop();
        }
        this.currentAudio = null;
      }
      this.isPlaying = false;
      
      // 停止进度条更新
      if (this.progressUpdateInterval) {
        clearInterval(this.progressUpdateInterval);
        this.progressUpdateInterval = null;
      }
      
      
      this.$emit('play-stop');
    },

    onWaveformClick(event, trackName) {
      if (!this.audioBuffers[trackName]) return;
      
      const canvas = event.target;
      const rect = canvas.getBoundingClientRect();
      const clickX = event.clientX - rect.left;
      const canvasWidth = rect.width;
      
      // 计算点击位置对应的时间（基于波形区域）
      const clickTime = (clickX / canvasWidth) * this.audioDuration;
      const beforeIsPlaying = this.isPlaying;
      if(beforeIsPlaying) {
        this.stopPlay();
      }
      // 只更新进度条位置，不自动播放
      this.seekToTime(clickTime);
      if(beforeIsPlaying) {
        this.startPlay();
      }
    },

    seekToTime(time) {
      // 只更新进度条位置，不自动播放
      this.currentSeekTime = time;
      
      // 更新进度条位置
      const firstCanvasName = Object.keys(this.audioBuffers)[0];
      const firstCanvas = this.$refs['waveform-' + firstCanvasName];
      if (firstCanvas && firstCanvas[0]) {
        const canvasWidth = firstCanvas[0].width / 2;
        const progress = time / this.audioDuration;
        this.progressBarPosition = progress * canvasWidth;
      }
      
      this.$emit('seek', time);
    },

    updateProgressBar() {
      if (!this.isPlaying || this.audioDuration === 0) return;
      
      const currentTime = (Date.now() / 1000) - this.audioStartTime;
      this.currentSeekTime = currentTime;
      const progress = Math.min(currentTime / this.audioDuration, 1);
      
      // 获取第一个canvas的宽度来计算进度条位置
      const firstCanvasName = Object.keys(this.audioBuffers)[0];
      const firstCanvas = this.$refs['waveform-' + firstCanvasName];
      if (firstCanvas && firstCanvas[0]) {
        // 使用canvas的显示宽度（不包括左侧文字区域）
        const canvasWidth = firstCanvas[0].width / 2; // 除以2是因为canvas的实际宽度是显示宽度的2倍
        this.progressBarPosition = progress * canvasWidth;
      }
      
      // 如果播放结束，停止播放
      if (progress >= 1) {
        this.currentSeekTime = 0;
        this.progressBarPosition = 0;
        this.stopPlay();
      }
      
      this.$emit('progress', {
        currentTime,
        duration: this.audioDuration,
        progress
      });
    },

    downloadAll() {
      try {
        Object.entries(this.audioBuffers).forEach(([name, buffer]) => {
          // 将AudioBuffer转换为WAV Blob
          const wavBlob = this.audioBufferToWav(buffer);
          const url = URL.createObjectURL(wavBlob);
          const a = document.createElement('a');
          a.href = url;
          
          // 构建文件名：原始文件名_音轨名.wav
          let fileName = `${name}.wav`;
          if (this.originalFileName) {
            // 移除原始文件的扩展名
            const baseName = this.originalFileName.replace(/\.[^/.]+$/, '');
            fileName = `${baseName}_${name}.wav`;
          }
          
          a.download = fileName;
          a.click();
          URL.revokeObjectURL(url);
        });
        
        push.success({
          title: '下载完成',
          description: '所有音轨文件已开始下载',
          duration: 3000,
        });
        
        this.$emit('download');
      } catch (error) {
        console.error('下载失败:', error);
        push.error({
          title: '下载失败',
          description: error.message,
          duration: 3000,
        });
      }
    },

    audioBufferToWav(buffer) {
      const numChannels = buffer.numberOfChannels;
      const sampleRate = buffer.sampleRate;
      const length = buffer.length;
      const bytesPerSample = 2; // 16-bit
      const blockAlign = numChannels * bytesPerSample;
      
      // 创建WAV头部
      const header = new ArrayBuffer(44);
      const view = new DataView(header);
      
      // RIFF标识
      this.writeString(view, 0, 'RIFF');
      // 文件长度 (data size + 36)
      view.setUint32(4, 36 + length * blockAlign, true);
      // WAVE标识
      this.writeString(view, 8, 'WAVE');
      // fmt子块
      this.writeString(view, 12, 'fmt ');
      // fmt块长度
      view.setUint32(16, 16, true);
      // 格式类型 (1 = PCM)
      view.setUint16(20, 1, true);
      // 声道数
      view.setUint16(22, numChannels, true);
      // 采样率
      view.setUint32(24, sampleRate, true);
      // 字节率 (sampleRate * blockAlign)
      view.setUint32(28, sampleRate * blockAlign, true);
      // 块对齐 (numChannels * bytesPerSample)
      view.setUint16(32, blockAlign, true);
      // 位深度
      view.setUint16(34, bytesPerSample * 8, true);
      // data标识
      this.writeString(view, 36, 'data');
      // 数据长度 (numSamples * blockAlign)
      view.setUint32(40, length * blockAlign, true);
      
      // 合并头部和PCM数据
      const data = new Float32Array(length * numChannels);
      for (let channel = 0; channel < numChannels; channel++) {
        const channelData = buffer.getChannelData(channel);
        for (let i = 0; i < length; i++) {
          data[i * numChannels + channel] = channelData[i];
        }
      }
      
      const pcm16 = new Int16Array(data.length);
      for (let i = 0; i < data.length; i++) {
        const s = Math.max(-1, Math.min(1, data[i]));
        pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
      }
      
      return new Blob([view, pcm16], { type: 'audio/wav' });
    },

    writeString(view, offset, string) {
      for (let i = 0; i < string.length; i++) {
        view.setUint8(offset + i, string.charCodeAt(i));
      }
    },

    deleteAll() {
      // 停止当前播放
      this.stopPlay();
      
      // 重置所有状态
      this.isPlaying = false;
      this.currentAudio = null;
      this.progressBarPosition = 0;
      this.audioStartTime = 0;
      this.audioDuration = 0;
      this.currentSeekTime = 0;
      
      // 清理进度更新定时器
      if (this.progressUpdateInterval) {
        clearInterval(this.progressUpdateInterval);
        this.progressUpdateInterval = null;
      }
      
      // 通知父组件重置状态
      this.$emit('delete-all');
      
      push.success({
        title: '已清理',
        description: '已清理当前运行结果，可以重新上传音频',
        duration: 2000,
      });
    }
  },
  beforeDestroy() {
    // 组件销毁时清理资源
    this.stopPlay();
    if (this.progressUpdateInterval) {
      clearInterval(this.progressUpdateInterval);
    }
  }
}
</script>

<style scoped>
.waveform-canvas {
  background: #f3f4f6;
  border-radius: 0;
  transition: all 0.3s ease;
}
</style> 